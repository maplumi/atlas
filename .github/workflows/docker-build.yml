name: Build Docker Images (no push)

on:
  push:
    tags: [ "v*" ]

jobs:
  build-images:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate tag matches app versions
        run: |
          set -e
          TAG="${GITHUB_REF_NAME}"
          VERSION="${TAG#v}"
          VERSION="$VERSION" python - <<'PY'
          import json, os, subprocess, sys
          version = os.environ["VERSION"]
            data = subprocess.check_output(["cargo", "metadata", "--format-version=1", "--no-deps"]).decode()
            meta = json.loads(data)
            packages = meta.get("packages", [])
            found = {pkg["name"]: pkg["version"] for pkg in packages}
            if not found:
              print("no packages found in cargo metadata")
              sys.exit(1)
            mismatched = [name for name, v in found.items() if v != version]
            if mismatched:
              for name in sorted(mismatched):
                print(f"version mismatch: {name} is {found.get(name)} but tag is {version}")
              sys.exit(1)
            print("version check OK for all crates")
          PY

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build terrain_server image
        run: |
          docker build \
            -f crates/apps/terrain_server/Dockerfile \
            -t atlas-server:${{ github.ref_name }} \
            .

      - name: Build viewer_web image
        run: |
          docker build \
            -f crates/apps/viewer_web/Dockerfile \
            -t atlas-viewer:${{ github.ref_name }} \
            .

      - name: Save images to artifacts
        run: |
          mkdir -p artifacts
          docker save atlas-server:${{ github.ref_name }} | gzip > artifacts/atlas-server-${{ github.ref_name }}.tar.gz
          docker save atlas-viewer:${{ github.ref_name }} | gzip > artifacts/atlas-viewer-${{ github.ref_name }}.tar.gz

      - name: Upload image artifacts
        uses: actions/upload-artifact@v4
        with:
          name: atlas-docker-images
          path: artifacts/*.tar.gz
          if-no-files-found: error
