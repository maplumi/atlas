services:
  web:
    image: atlas-viewer:${ATLAS_TAG:-dev}
    build:
      context: .
      dockerfile: crates/apps/web/Dockerfile
    ports:
      - "9103:9103"
    depends_on:
      - server

  server:
    image: atlas-server:${ATLAS_TAG:-dev}
    build:
      context: .
      dockerfile: crates/apps/server/Dockerfile
    ports:
      - "9102:9100"
    environment:
      TERRAIN_ADDR: "0.0.0.0:9100"
      TERRAIN_ROOT: "/data/terrain"
      SURFACE_ROOT: "/data/terrain/surface"
      STAC_URL: "https://copernicus-dem-30m-stac.s3.amazonaws.com"
      TERRAIN_COLLECTION: "${TERRAIN_COLLECTION:-dem_cop_30}"
      TERRAIN_VERTICAL_DATUM: "${TERRAIN_VERTICAL_DATUM:-msl-egm2008}"
      TERRAIN_VERTICAL_UNITS: "${TERRAIN_VERTICAL_UNITS:-m}"
      TERRAIN_TILE_SIZE: "${TERRAIN_TILE_SIZE:-256}"
      TERRAIN_ZOOM_MIN: "${TERRAIN_ZOOM_MIN:-0}"
      TERRAIN_ZOOM_MAX: "${TERRAIN_ZOOM_MAX:-8}"
      TERRAIN_SAMPLE_STEP: "${TERRAIN_SAMPLE_STEP:-4}"
      TERRAIN_NO_DATA: "${TERRAIN_NO_DATA:--9999}"
      TERRAIN_MIN_LON: "${TERRAIN_MIN_LON:--180}"
      TERRAIN_MAX_LON: "${TERRAIN_MAX_LON:-180}"
      TERRAIN_MIN_LAT: "${TERRAIN_MIN_LAT:--90}"
      TERRAIN_MAX_LAT: "${TERRAIN_MAX_LAT:-90}"
      TERRAIN_MAX_COGS_PER_TILE: "${TERRAIN_MAX_COGS_PER_TILE:-16}"
    volumes:
      - terrain-data:/data/terrain
      - ./data/terrain/surface:/data/terrain/surface:ro

volumes:
  terrain-data:
