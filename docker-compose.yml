services:
  web:
    image: atlas-viewer:${ATLAS_TAG:-dev}
    build:
      context: .
      dockerfile: crates/apps/web/Dockerfile
    ports:
      - "8082:80"
    depends_on:
      - server

  server:
    image: atlas-server:${ATLAS_TAG:-dev}
    build:
      context: .
      dockerfile: crates/apps/server/Dockerfile
    ports:
      - "9102:9100"
    environment:
      TERRAIN_ADDR: "0.0.0.0:9100"
      TERRAIN_ROOT: "/data/terrain"
      STAC_URL: "https://copernicus-dem-30m-stac.s3.amazonaws.com"
    volumes:
      - terrain-data:/data/terrain

  dem-pipeline:
    image: atlas-dem-pipeline:${ATLAS_TAG:-dev}
    build:
      context: .
      dockerfile: crates/apps/server/Dockerfile.dem-pipeline
    environment:
      STAC_URL: "https://copernicus-dem-30m-stac.s3.amazonaws.com"
      TERRAIN_COLLECTION: "${TERRAIN_COLLECTION:-dem_cop_30}"
      TERRAIN_BBOX: "${TERRAIN_BBOX:--180,-90,180,90}"
      TERRAIN_LIMIT: "${TERRAIN_LIMIT:-200}"
      TERRAIN_ZOOM_MIN: "${TERRAIN_ZOOM_MIN:-0}"
      TERRAIN_ZOOM_MAX: "${TERRAIN_ZOOM_MAX:-2}"
      TERRAIN_TILE_SIZE: "${TERRAIN_TILE_SIZE:-256}"
      TERRAIN_SAMPLE_STEP: "${TERRAIN_SAMPLE_STEP:-4}"
      TERRAIN_NO_DATA: "${TERRAIN_NO_DATA:--9999}"
      TERRAIN_FORCE_REBUILD: "${TERRAIN_FORCE_REBUILD:-0}"
    volumes:
      - terrain-data:/data/terrain
    restart: "no"

volumes:
  terrain-data:
