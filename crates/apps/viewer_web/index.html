<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Atlas Viewer (Web)</title>
    <link data-trunk rel="rust" data-wasm-opt="z" />
    <link data-trunk rel="copy-dir" href="assets" />
    <style>
      * { box-sizing: border-box; }
      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        background: #020617;
        color: #e2e8f0;
        font-family: "Inter", "JetBrains Mono", system-ui, sans-serif;
      }
      #app {
        width: 100%;
        height: 100%;
        display: grid;
        grid-template-columns: 320px 1fr;
        grid-template-rows: 1fr;
      }
      #side-panel {
        background: #0b132b;
        border-right: 1px solid #1f2a44;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      #atlas-canvas-3d {
        width: 100%;
        height: 100%;
        display: block;
        touch-action: none;
      }
      .section {
        border: 1px solid #1f2a44;
        border-radius: 8px;
        padding: 12px;
        background: #0f172a;
      }
      .section h3 {
        margin: 0 0 8px 0;
        font-size: 14px;
        letter-spacing: 0.3px;
        color: #93c5fd;
      }
      label { display: block; margin-bottom: 8px; font-size: 13px; color: #cbd5e1; }
      select, button, input[type="checkbox"] {
        font-size: 13px;
      }
      button {
        padding: 8px 10px;
        margin-right: 6px;
        border: 1px solid #1f2a44;
        background: #111827;
        color: #e5e7eb;
        border-radius: 6px;
        cursor: pointer;
      }
      button.active { background: #2563eb; border-color: #3b82f6; }
      select { width: 100%; padding: 6px; border-radius: 6px; border: 1px solid #1f2a44; background: #0f172a; color: #e5e7eb; }
      .checkbox { display: flex; gap: 8px; align-items: center; }
    </style>
  </head>
  <body>
    <div id="app">
      <div id="side-panel">
        <div class="section">
          <h3>Datasets</h3>
          <label for="dataset">Choose dataset</label>
          <select id="dataset">
            <option value="" selected>Loadingâ€¦</option>
          </select>
        </div>
        <div class="section">
          <h3>Overlays</h3>
          <label class="checkbox">
            <input id="toggle-graticule" type="checkbox" />
            <span>Show graticule</span>
          </label>
        </div>
        <div class="section">
          <h3>Status</h3>
          <div id="status-text" style="font-size:12px; color:#cbd5e1;">Ready</div>
        </div>
      </div>
      <canvas id="atlas-canvas-3d" width="1280" height="720"></canvas>
    </div>
    <script type="module">
      function main(wasm) {
        wireUi(wasm);
        resizeCanvas(wasm);
        window.addEventListener("resize", () => resizeCanvas(wasm));
        wasm.init_wgpu();
        // preload built-in dataset
        const manifestUrl = new URL("./assets/scene.manifest.json", import.meta.url).toString();
        wasm.load_dataset(manifestUrl);
        populateDatasets(manifestUrl, wasm);
        startAnimation(wasm);
      }

      async function populateDatasets(manifestUrl, wasm) {
        const select = document.getElementById("dataset");
        try {
          const resp = await fetch(manifestUrl);
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const manifest = await resp.json();

          const chunks = Array.isArray(manifest.chunks) ? manifest.chunks : [];
          // Clear existing options.
          select.innerHTML = "";

          // Populate from manifest chunks.
          if (chunks.length === 0) {
            const opt = document.createElement("option");
            opt.value = "";
            opt.textContent = "(no datasets found)";
            select.appendChild(opt);
            return;
          }

          for (const c of chunks) {
            const id = String(c.id ?? "");
            if (!id) continue;
            const kind = c.kind ? String(c.kind) : "";
            const opt = document.createElement("option");
            opt.value = id;
            opt.textContent = kind ? `${id} (${kind})` : id;
            select.appendChild(opt);
          }

          // Default selection: first dataset.
          select.value = select.options[0]?.value ?? "";
          if (select.value) {
            try {
              wasm.set_dataset(select.value);
            } catch (err) {
              console.error("set_dataset failed", err);
            }
          }
        } catch (err) {
          console.error("Failed to populate datasets", err);
          select.innerHTML = "";
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "Failed to load datasets";
          select.appendChild(opt);
        }
      }

      function startAnimation(wasm) {
        function loop() {
          try {
            wasm.advance_frame();
          } catch (e) {
            console.error("advance_frame failed", e);
            return;
          }
          window.requestAnimationFrame(loop);
        }
        window.requestAnimationFrame(loop);
      }

      function resizeCanvas(wasm) {
        const panel = document.getElementById("side-panel");
        const width = window.innerWidth - panel.offsetWidth;
        const height = window.innerHeight;
        const canvas3d = document.getElementById("atlas-canvas-3d");
        canvas3d.width = width;
        canvas3d.height = height;
        wasm.set_canvas_sizes(width, height);
      }

      function setStatus(text) {
        document.getElementById("status-text").textContent = text;
      }

      function wireUi(wasm) {
        const dataset = document.getElementById("dataset");
        const toggleGraticule = document.getElementById("toggle-graticule");
        const canvas = document.getElementById("atlas-canvas-3d");

        canvas.addEventListener("contextmenu", (e) => e.preventDefault());

        let dragging = false;
        let dragMode = "orbit"; // orbit | pan
        let lastX = 0;
        let lastY = 0;

        canvas.addEventListener("pointerdown", (e) => {
          canvas.setPointerCapture(e.pointerId);
          dragging = true;
          lastX = e.clientX;
          lastY = e.clientY;

          // left = orbit, right = pan, shift+left = pan
          if (e.button === 2 || e.shiftKey) {
            dragMode = "pan";
          } else {
            dragMode = "orbit";
          }
        });

        canvas.addEventListener("pointermove", (e) => {
          if (!dragging) return;
          const dx = e.clientX - lastX;
          const dy = e.clientY - lastY;
          lastX = e.clientX;
          lastY = e.clientY;

          try {
            if (dragMode === "pan") {
              wasm.camera_pan(dx, dy);
            } else {
              wasm.camera_orbit(dx, dy);
            }
          } catch (err) {
            console.error("camera input failed", err);
          }
        });

        function stopDrag() {
          dragging = false;
        }
        canvas.addEventListener("pointerup", stopDrag);
        canvas.addEventListener("pointercancel", stopDrag);
        canvas.addEventListener("pointerleave", stopDrag);

        canvas.addEventListener(
          "wheel",
          (e) => {
            e.preventDefault();
            try {
              wasm.camera_zoom(e.deltaY);
            } catch (err) {
              console.error("camera_zoom failed", err);
            }
          },
          { passive: false }
        );

        window.addEventListener("keydown", (e) => {
          if (e.key === "r" || e.key === "R") {
            try {
              wasm.camera_reset();
            } catch (err) {
              console.error("camera_reset failed", err);
            }
          }
        });

        dataset.addEventListener("change", (e) => {
          const value = e.target.value;
          if (!value) return;
          wasm.set_dataset(value);
          setStatus(`Dataset: ${value}`);
        });

        toggleGraticule.addEventListener("change", (e) => {
          const enabled = !!e.target.checked;
          try {
            wasm.set_graticule_enabled(enabled);
          } catch (err) {
            console.error("set_graticule_enabled failed", err);
          }
        });

        setStatus("Controls: LMB drag=orbit, RMB/Shift+drag=pan, wheel=zoom, R=reset");
      }

      function bootstrap() {
        const alreadyLoaded = window.wasmBindings;
        if (alreadyLoaded) {
          main(alreadyLoaded);
          return;
        }

        window.addEventListener("TrunkApplicationStarted", () => {
          if (!window.wasmBindings) {
            console.error("Trunk started but wasmBindings missing");
            return;
          }
          main(window.wasmBindings);
        });
      }

      bootstrap();
    </script>
  </body>
</html>
