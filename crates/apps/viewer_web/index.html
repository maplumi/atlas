<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Atlas Viewer (Web)</title>
    <link data-trunk rel="rust" data-wasm-opt="z" />
    <link data-trunk rel="copy-dir" href="assets" />
    <style>
      * { box-sizing: border-box; }
      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        background: #020617;
        color: #e2e8f0;
        font-family: "Inter", "JetBrains Mono", system-ui, sans-serif;
      }
      #app {
        width: 100%;
        height: 100%;
        display: grid;
        grid-template-columns: var(--panel-width, 320px) 1fr;
        grid-template-rows: 1fr;
      }
      #side-panel {
        background: #0b132b;
        border-right: 1px solid #1f2a44;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 16px;
        position: relative;
        overflow-y: auto;
        overflow-x: hidden;
        min-width: 280px;
        max-width: 600px;
      }
      #side-panel.collapsed {
        min-width: 0;
        padding: 0;
        border-right: none;
      }
      #side-panel.collapsed > *:not(#panel-toggle) {
        display: none;
      }
      #panel-toggle {
        position: absolute;
        top: 12px;
        right: -36px;
        width: 32px;
        height: 32px;
        border: 1px solid #1f2a44;
        background: #0b132b;
        color: #e5e7eb;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        z-index: 10;
        padding: 0;
        margin: 0;
      }
      #panel-toggle:hover {
        background: #111827;
        border-color: #3b82f6;
      }
      #panel-resize-handle {
        position: absolute;
        top: 0;
        right: 0;
        width: 5px;
        height: 100%;
        cursor: col-resize;
        background: transparent;
        z-index: 5;
      }
      #panel-resize-handle:hover {
        background: rgba(59, 130, 246, 0.3);
      }
      #panel-resize-handle.resizing {
        background: rgba(59, 130, 246, 0.5);
      }
      .tabs {
        display: flex;
        gap: 8px;
      }
      .tab-btn {
        flex: 1;
        padding: 8px 10px;
        border: 1px solid #1f2a44;
        background: #111827;
        color: #e5e7eb;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
      }
      .tab-btn.active {
        background: #2563eb;
        border-color: #3b82f6;
      }
      .tab-page.hidden { display: none; }
      #atlas-canvas-2d,
      #atlas-canvas-3d {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        display: block;
        touch-action: none;
      }
      #atlas-canvas-2d.hidden,
      #atlas-canvas-3d.hidden {
        display: none;
      }
      #map-area {
        position: relative;
        width: 100%;
        height: 100%;
        overflow: hidden;
      }
      .map-controls {
        position: absolute;
        top: 12px;
        right: 12px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 10px;
        border: 1px solid rgba(31, 42, 68, 0.9);
        background: rgba(15, 23, 42, 0.72);
        backdrop-filter: blur(8px);
        border-radius: 12px;
        user-select: none;
      }
      .map-controls-row {
        display: flex;
        gap: 8px;
        align-items: center;
        justify-content: flex-end;
        padding-bottom: 4px;
        border-bottom: 1px solid rgba(31, 42, 68, 0.75);
        margin-bottom: 2px;
      }
      .map-controls[data-pos="left"] {
        left: 12px;
        right: auto;
      }
      .map-controls .btn {
        width: 38px;
        height: 38px;
        padding: 0;
        margin: 0;
        border-radius: 10px;
        display: grid;
        place-items: center;
        font-weight: 800;
        line-height: 1;
      }
      .map-controls .btn.small {
        width: 38px;
        height: 30px;
        font-weight: 700;
        font-size: 12px;
      }
      #map-compass {
        width: 38px;
        height: 38px;
        border-radius: 999px;
        position: relative;
        padding: 0;
      }
      #map-compass .compass-label {
        position: absolute;
        top: 6px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 11px;
        font-weight: 900;
        color: #e5e7eb;
        letter-spacing: 0.5px;
        pointer-events: none;
      }
      #compass-needle {
        position: absolute;
        left: 50%;
        top: 50%;
        width: 2px;
        height: 13px;
        background: #ef4444;
        border-radius: 2px;
        transform-origin: 50% 100%;
        transform: translate(-50%, -100%) rotate(0deg);
        pointer-events: none;
      }
      .map-controls .hint {
        max-width: 220px;
        font-size: 12px;
        color: #cbd5e1;
        line-height: 1.35;
      }
      .map-controls .hint.hidden {
        display: none;
      }
      .section {
        border: 1px solid #1f2a44;
        border-radius: 8px;
        padding: 12px;
        background: #0f172a;
      }
      .section h3 {
        margin: 0 0 8px 0;
        font-size: 14px;
        letter-spacing: 0.3px;
        color: #93c5fd;
      }
      label { display: block; margin-bottom: 8px; font-size: 13px; color: #cbd5e1; }
      select, button, input[type="checkbox"] {
        font-size: 13px;
      }
      button {
        padding: 8px 10px;
        margin-right: 6px;
        border: 1px solid #1f2a44;
        background: #111827;
        color: #e5e7eb;
        border-radius: 6px;
        cursor: pointer;
      }
      button.active { background: #2563eb; border-color: #3b82f6; }
      select { width: 100%; padding: 6px; border-radius: 6px; border: 1px solid #1f2a44; background: #0f172a; color: #e5e7eb; }
      .checkbox { display: flex; gap: 8px; align-items: center; }
      .row { display: flex; align-items: center; gap: 10px; }
      input[type="range"] { width: 100%; }
      .value { font-variant-numeric: tabular-nums; color: #cbd5e1; font-size: 12px; }
      .layer-row {
        display: grid;
        grid-template-columns: 1fr 44px 1fr 1fr;
        gap: 10px;
        align-items: center;
        margin-top: 8px;
      }
      .layer-row .mini { font-size: 11px; color: #94a3b8; }
    </style>
  </head>
  <body>
    <div id="app">
      <div id="side-panel">
        <button id="panel-toggle" type="button" title="Collapse panel">◀</button>
        <div id="panel-resize-handle"></div>
        <div class="tabs">
          <button id="tab-general-btn" class="tab-btn active" type="button">General</button>
          <button id="tab-layers-btn" class="tab-btn" type="button">Layers</button>
          <button id="tab-settings-btn" class="tab-btn" type="button">Settings</button>
        </div>

        <div id="tab-general" class="tab-page">
          <div class="section">
            <h3>Mode</h3>
            <div class="tabs">
              <button id="mode-2d" class="tab-btn" type="button">2D</button>
              <button id="mode-3d" class="tab-btn active" type="button">3D</button>
            </div>
            <div style="font-size:12px; color:#94a3b8; line-height:1.35; margin-top:8px;">
              Switches the active surface. Layers and dataset stay the same.
            </div>
          </div>

          <div class="section">
            <h3>Datasets</h3>
            <label for="dataset">Choose dataset</label>
            <select id="dataset">
              <option value="" selected>Loading…</option>
            </select>
          </div>

          <div class="section">
            <h3>Upload</h3>
            <label for="file-geojson">Upload GIS file (GeoJSON)</label>
            <input id="file-geojson" type="file" accept=".json,.geojson,application/geo+json,application/json" />
            <div style="font-size:12px; color:#94a3b8; line-height:1.35; margin-top:8px;">
              Supports GeoJSON FeatureCollection/Feature/bare geometry with Point/LineString/Polygon (+ Multi*).
            </div>
            <div id="uploaded-info" style="margin-top:10px; font-size:12px; color:#cbd5e1; line-height:1.35;">
              <div style="color:#94a3b8;">No upload loaded.</div>
            </div>
          </div>
          <div class="section">
            <h3>Overlays</h3>
            <label class="checkbox">
              <input id="toggle-graticule" type="checkbox" />
              <span>Show graticule</span>
            </label>
          </div>
          <div class="section">
            <h3>Status</h3>
            <div id="status-text" style="font-size:12px; color:#cbd5e1;">Ready</div>
            <div id="cursor-text" style="font-size:12px; color:#94a3b8; margin-top:6px;">Cursor: —</div>
            <div id="pick-text" style="font-size:12px; color:#94a3b8; margin-top:2px;">Pick: —</div>
          </div>
        </div>

        <div id="tab-layers" class="tab-page hidden">
          <div class="section">
            <h3>Points</h3>
            <label for="city-size">Point size (px)</label>
            <div class="row">
              <input id="city-size" type="range" min="1" max="24" step="1" value="4" />
              <span id="city-size-value" class="value">4</span>
            </div>
          </div>

          <div class="section">
            <h3>Lines</h3>
            <label for="line-width">Line width (px)</label>
            <div class="row">
              <input id="line-width" type="range" min="1" max="16" step="0.5" value="2.5" />
              <span id="line-width-value" class="value">2.5</span>
            </div>
            <div style="font-size:12px; color:#94a3b8; line-height:1.35; margin-top:8px;">
              Note: this viewer uses simple per-layer styles (color/opacity/lift/width), not rule-based GIS symbology.
            </div>
          </div>

          <div class="section">
            <h3>Layers</h3>

            <div class="layer-row">
              <label class="checkbox">
                <input id="layer-cities" type="checkbox" />
                <span>Cities (built-in)</span>
              </label>
              <input id="layer-cities-color" type="color" value="#ff4040" />
              <div>
                <div class="mini">Opacity</div>
                <input id="layer-cities-opacity" type="range" min="0" max="1" step="0.01" value="0.95" />
              </div>
              <div>
                <div class="mini">Lift</div>
                <input id="layer-cities-lift" type="range" min="-0.02" max="0.05" step="0.001" value="0.00" />
              </div>
            </div>

            <div class="layer-row">
              <label class="checkbox">
                <input id="layer-corridors" type="checkbox" />
                <span>Air corridors (built-in)</span>
              </label>
              <input id="layer-corridors-color" type="color" value="#ffd640" />
              <div>
                <div class="mini">Opacity</div>
                <input id="layer-corridors-opacity" type="range" min="0" max="1" step="0.01" value="0.90" />
              </div>
              <div>
                <div class="mini">Lift</div>
                <input id="layer-corridors-lift" type="range" min="-0.02" max="0.05" step="0.001" value="0.00" />
              </div>
            </div>

            <div class="layer-row">
              <label class="checkbox">
                <input id="layer-regions" type="checkbox" />
                <span>Regions (built-in)</span>
              </label>
              <input id="layer-regions-color" type="color" value="#19e6bf" />
              <div>
                <div class="mini">Opacity</div>
                <input id="layer-regions-opacity" type="range" min="0" max="1" step="0.01" value="0.30" />
              </div>
              <div>
                <div class="mini">Lift</div>
                <input id="layer-regions-lift" type="range" min="-0.02" max="0.05" step="0.001" value="0.00" />
              </div>
            </div>

            <div class="layer-row">
              <label class="checkbox">
                <input id="layer-uploaded-points" type="checkbox" />
                <span id="layer-uploaded-points-label">Uploaded points</span>
              </label>
              <input id="layer-uploaded-points-color" type="color" value="#99f2ff" />
              <div>
                <div class="mini">Opacity</div>
                <input id="layer-uploaded-points-opacity" type="range" min="0" max="1" step="0.01" value="0.95" />
              </div>
              <div>
                <div class="mini">Lift</div>
                <input id="layer-uploaded-points-lift" type="range" min="-0.02" max="0.05" step="0.001" value="0.00" />
              </div>
            </div>

            <div class="layer-row">
              <label class="checkbox">
                <input id="layer-uploaded-corridors" type="checkbox" />
                <span id="layer-uploaded-corridors-label">Uploaded lines</span>
              </label>
              <input id="layer-uploaded-corridors-color" type="color" value="#d9f299" />
              <div>
                <div class="mini">Opacity</div>
                <input id="layer-uploaded-corridors-opacity" type="range" min="0" max="1" step="0.01" value="0.90" />
              </div>
              <div>
                <div class="mini">Lift</div>
                <input id="layer-uploaded-corridors-lift" type="range" min="-0.02" max="0.05" step="0.001" value="0.00" />
              </div>
            </div>

            <div class="layer-row">
              <label class="checkbox">
                <input id="layer-uploaded-regions" type="checkbox" />
                <span id="layer-uploaded-regions-label">Uploaded polygons</span>
              </label>
              <input id="layer-uploaded-regions-color" type="color" value="#73b7ff" />
              <div>
                <div class="mini">Opacity</div>
                <input id="layer-uploaded-regions-opacity" type="range" min="0" max="1" step="0.01" value="0.25" />
              </div>
              <div>
                <div class="mini">Lift</div>
                <input id="layer-uploaded-regions-lift" type="range" min="-0.02" max="0.05" step="0.001" value="0.00" />
              </div>
            </div>

            <div style="font-size:12px; color:#94a3b8; line-height:1.35; margin-top:10px;">
              Tip: you can enable multiple layers at once. Click on a point layer to pick the nearest marker.
            </div>
          </div>
        </div>

        <div id="tab-settings" class="tab-page hidden">
          <div class="section">
            <h3>Lighting</h3>
            <label class="checkbox">
              <input id="toggle-real-sun" type="checkbox" checked />
              <span>Real-time sun shadows</span>
            </label>
            <div style="font-size:12px; color:#94a3b8; line-height:1.35;">
              Syncs the globe lighting to your current system time.
            </div>
          </div>
        </div>
      </div>
      <div id="map-area">
        <canvas id="atlas-canvas-2d" width="1280" height="720" class="hidden"></canvas>
        <canvas id="atlas-canvas-3d" width="1280" height="720"></canvas>
        <div id="map-controls" class="map-controls" data-pos="right" aria-label="Map controls">
          <div class="map-controls-row" aria-label="View and compass">
            <button id="map-view" class="btn small" type="button" title="Toggle 2D/3D view">3D</button>
            <button id="map-compass" class="btn" type="button" title="North/South orientation">
              <span id="compass-needle" aria-hidden="true"></span>
              <span class="compass-label" aria-hidden="true">N</span>
            </button>
          </div>
          <button id="map-home" class="btn" type="button" title="Reset camera (R)">⌂</button>
          <button id="map-zoom-in" class="btn" type="button" title="Zoom in">+</button>
          <button id="map-zoom-out" class="btn" type="button" title="Zoom out">−</button>
          <button id="map-mode" class="btn small" type="button" title="Lock drag mode">Auto</button>
          <button id="map-graticule" class="btn small" type="button" title="Toggle graticule">Grid</button>
          <button id="map-sun" class="btn small" type="button" title="Toggle real-time sun">Sun</button>
          <button id="map-help" class="btn small" type="button" title="Show controls">?</button>
          <div id="map-help-text" class="hint hidden">
            3D: LMB drag orbit • RMB/Shift pan<br />
            2D: drag pan<br />
            Wheel: zoom • Click: pick<br />
            R: reset
          </div>
        </div>
      </div>
    </div>
    <script type="module">
      function main(wasm) {
        wireUi(wasm);
        resizeCanvas(wasm);
        window.addEventListener("resize", () => resizeCanvas(wasm));
        wasm.init_canvas_2d();
        wasm.init_wgpu();
        // preload built-in dataset
        const manifestUrl = new URL("./assets/scene.manifest.json", import.meta.url).toString();
        wasm.load_dataset(manifestUrl);
        populateDatasets(manifestUrl, wasm);
        startAnimation(wasm);
      }

      async function populateDatasets(manifestUrl, wasm) {
        const select = document.getElementById("dataset");
        try {
          const resp = await fetch(manifestUrl);
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const manifest = await resp.json();

          const chunks = Array.isArray(manifest.chunks) ? manifest.chunks : [];
          // Clear existing options.
          select.innerHTML = "";

          // Populate from manifest chunks.
          if (chunks.length === 0) {
            const opt = document.createElement("option");
            opt.value = "";
            opt.textContent = "(no datasets found)";
            select.appendChild(opt);
            return;
          }

          for (const c of chunks) {
            const id = String(c.id ?? "");
            if (!id) continue;
            const kind = c.kind ? String(c.kind) : "";
            const opt = document.createElement("option");
            opt.value = id;
            opt.textContent = kind ? `${id} (${kind})` : id;
            select.appendChild(opt);
          }

          // Default selection: first dataset.
          select.value = select.options[0]?.value ?? "";
          if (select.value) {
            try {
              wasm.set_dataset(select.value);
            } catch (err) {
              console.error("set_dataset failed", err);
            }
          }
        } catch (err) {
          console.error("Failed to populate datasets", err);
          select.innerHTML = "";
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "Failed to load datasets";
          select.appendChild(opt);
        }
      }

      function startAnimation(wasm) {
        function loop() {
          try {
            wasm.advance_frame();
            if (window.__atlasUpdateCompass) window.__atlasUpdateCompass();
          } catch (e) {
            console.error("advance_frame failed", e);
            return;
          }
          window.requestAnimationFrame(loop);
        }
        window.requestAnimationFrame(loop);
      }

      function resizeCanvas(wasm) {
        const panel = document.getElementById("side-panel");
        const width = window.innerWidth - panel.offsetWidth;
        const height = window.innerHeight;
        const canvas2d = document.getElementById("atlas-canvas-2d");
        const canvas3d = document.getElementById("atlas-canvas-3d");
        canvas2d.width = width;
        canvas2d.height = height;
        canvas3d.width = width;
        canvas3d.height = height;
        wasm.set_canvas_sizes(width, height);
      }

      function setStatus(text) {
        document.getElementById("status-text").textContent = text;
      }

      function wireUi(wasm) {
        const tabGeneralBtn = document.getElementById("tab-general-btn");
        const tabLayersBtn = document.getElementById("tab-layers-btn");
        const tabSettingsBtn = document.getElementById("tab-settings-btn");
        const tabGeneral = document.getElementById("tab-general");
        const tabLayers = document.getElementById("tab-layers");
        const tabSettings = document.getElementById("tab-settings");

        const dataset = document.getElementById("dataset");
        const fileGeoJson = document.getElementById("file-geojson");
        const uploadedInfo = document.getElementById("uploaded-info");
        const toggleGraticule = document.getElementById("toggle-graticule");
        const toggleRealSun = document.getElementById("toggle-real-sun");
        const citySize = document.getElementById("city-size");
        const citySizeValue = document.getElementById("city-size-value");
        const lineWidth = document.getElementById("line-width");
        const lineWidthValue = document.getElementById("line-width-value");
        const canvas2d = document.getElementById("atlas-canvas-2d");
        const canvas3d = document.getElementById("atlas-canvas-3d");

        const mode2dBtn = document.getElementById("mode-2d");
        const mode3dBtn = document.getElementById("mode-3d");

        const mapHome = document.getElementById("map-home");
        const mapZoomIn = document.getElementById("map-zoom-in");
        const mapZoomOut = document.getElementById("map-zoom-out");
        const mapView = document.getElementById("map-view");
        const mapCompass = document.getElementById("map-compass");
        const compassNeedle = document.getElementById("compass-needle");
        const mapMode = document.getElementById("map-mode");
        const mapGraticule = document.getElementById("map-graticule");
        const mapSun = document.getElementById("map-sun");
        const mapHelp = document.getElementById("map-help");
        const mapHelpText = document.getElementById("map-help-text");

        const cursorText = document.getElementById("cursor-text");
        const pickText = document.getElementById("pick-text");

        const layerCities = document.getElementById("layer-cities");
        const layerCitiesColor = document.getElementById("layer-cities-color");
        const layerCitiesOpacity = document.getElementById("layer-cities-opacity");
        const layerCitiesLift = document.getElementById("layer-cities-lift");

        const layerCorridors = document.getElementById("layer-corridors");
        const layerCorridorsColor = document.getElementById("layer-corridors-color");
        const layerCorridorsOpacity = document.getElementById("layer-corridors-opacity");
        const layerCorridorsLift = document.getElementById("layer-corridors-lift");

        const layerRegions = document.getElementById("layer-regions");
        const layerRegionsColor = document.getElementById("layer-regions-color");
        const layerRegionsOpacity = document.getElementById("layer-regions-opacity");
        const layerRegionsLift = document.getElementById("layer-regions-lift");

        const layerUploadedPoints = document.getElementById("layer-uploaded-points");
        const layerUploadedPointsLabel = document.getElementById("layer-uploaded-points-label");
        const layerUploadedPointsColor = document.getElementById("layer-uploaded-points-color");
        const layerUploadedPointsOpacity = document.getElementById("layer-uploaded-points-opacity");
        const layerUploadedPointsLift = document.getElementById("layer-uploaded-points-lift");

        const layerUploadedCorridors = document.getElementById("layer-uploaded-corridors");
        const layerUploadedCorridorsLabel = document.getElementById("layer-uploaded-corridors-label");
        const layerUploadedCorridorsColor = document.getElementById("layer-uploaded-corridors-color");
        const layerUploadedCorridorsOpacity = document.getElementById("layer-uploaded-corridors-opacity");
        const layerUploadedCorridorsLift = document.getElementById("layer-uploaded-corridors-lift");

        const layerUploadedRegions = document.getElementById("layer-uploaded-regions");
        const layerUploadedRegionsLabel = document.getElementById("layer-uploaded-regions-label");
        const layerUploadedRegionsColor = document.getElementById("layer-uploaded-regions-color");
        const layerUploadedRegionsOpacity = document.getElementById("layer-uploaded-regions-opacity");
        const layerUploadedRegionsLift = document.getElementById("layer-uploaded-regions-lift");

        function setUploadedInfo({ name, points, lines, polygons, skipped_coords, fixed_swapped, fixed_web_mercator, error }) {
          if (error) {
            uploadedInfo.innerHTML = `<div style="color:#fca5a5;">Upload error: ${String(error)}</div>`;
            return;
          }
          if (!name) {
            uploadedInfo.innerHTML = `<div style="color:#94a3b8;">No upload loaded.</div>`;
            return;
          }

          const skipped = Number(skipped_coords ?? 0);
          const swapped = Number(fixed_swapped ?? 0);
          const merc = Number(fixed_web_mercator ?? 0);
          const hasDiag = (skipped + swapped + merc) > 0;

          uploadedInfo.innerHTML = `
            <div><span style="color:#93c5fd;">Uploaded:</span> ${name}</div>
            <div style="color:#94a3b8;">Points: ${points ?? 0} • Lines: ${lines ?? 0} • Polygons: ${polygons ?? 0}</div>
            ${hasDiag ? `<div style="color:#94a3b8;">Coords: fixed swap ${swapped} • fixed mercator ${merc} • skipped ${skipped}</div>` : ""}
          `;
        }

        function wireLayerControls() {
          function bind(id, checkbox, color, opacity, lift) {
            checkbox.addEventListener("change", (e) => {
              try { wasm.set_layer_visible(id, !!e.target.checked); } catch (err) { console.error(err); }
            });
            color.addEventListener("input", (e) => {
              try { wasm.set_layer_color_hex(id, e.target.value); } catch (err) { console.error(err); }
            });
            opacity.addEventListener("input", (e) => {
              try { wasm.set_layer_opacity(id, Number(e.target.value)); } catch (err) { console.error(err); }
            });
            lift.addEventListener("input", (e) => {
              try { wasm.set_layer_lift(id, Number(e.target.value)); } catch (err) { console.error(err); }
            });
          }
          bind("cities", layerCities, layerCitiesColor, layerCitiesOpacity, layerCitiesLift);
          bind("air_corridors", layerCorridors, layerCorridorsColor, layerCorridorsOpacity, layerCorridorsLift);
          bind("regions", layerRegions, layerRegionsColor, layerRegionsOpacity, layerRegionsLift);
          bind("uploaded_points", layerUploadedPoints, layerUploadedPointsColor, layerUploadedPointsOpacity, layerUploadedPointsLift);
          bind("uploaded_corridors", layerUploadedCorridors, layerUploadedCorridorsColor, layerUploadedCorridorsOpacity, layerUploadedCorridorsLift);
          bind("uploaded_regions", layerUploadedRegions, layerUploadedRegionsColor, layerUploadedRegionsOpacity, layerUploadedRegionsLift);
        }

        wireLayerControls();

        function setTab(which) {
          const isGeneral = which === "general";
          const isLayers = which === "layers";
          const isSettings = which === "settings";

          tabGeneralBtn.classList.toggle("active", isGeneral);
          tabLayersBtn.classList.toggle("active", isLayers);
          tabSettingsBtn.classList.toggle("active", isSettings);

          tabGeneral.classList.toggle("hidden", !isGeneral);
          tabLayers.classList.toggle("hidden", !isLayers);
          tabSettings.classList.toggle("hidden", !isSettings);
        }

        tabGeneralBtn.addEventListener("click", () => setTab("general"));
        tabLayersBtn.addEventListener("click", () => setTab("layers"));
        tabSettingsBtn.addEventListener("click", () => setTab("settings"));

        let viewMode = "3d"; // 2d | 3d

        function applyViewMode(next) {
          viewMode = next === "2d" ? "2d" : "3d";
          canvas2d.classList.toggle("hidden", viewMode !== "2d");
          canvas3d.classList.toggle("hidden", viewMode !== "3d");
          mode2dBtn?.classList.toggle("active", viewMode === "2d");
          mode3dBtn?.classList.toggle("active", viewMode === "3d");
          if (mapView) mapView.textContent = viewMode.toUpperCase();
          try { wasm.set_view_mode(viewMode); } catch (err) { console.error("set_view_mode failed", err); }
          updateCompass();
        }

        mode2dBtn?.addEventListener("click", () => applyViewMode("2d"));
        mode3dBtn?.addEventListener("click", () => applyViewMode("3d"));
        mapView?.addEventListener("click", () => applyViewMode(viewMode === "3d" ? "2d" : "3d"));

        function activeCanvas() {
          return viewMode === "2d" ? canvas2d : canvas3d;
        }

        for (const c of [canvas2d, canvas3d]) {
          c.addEventListener("contextmenu", (e) => e.preventDefault());
        }

        function updateCompass() {
          if (!compassNeedle) return;
          let yawDeg = 0;
          if (viewMode === "3d") {
            try {
              yawDeg = Number(wasm.get_camera_yaw_deg?.() ?? 0);
            } catch (err) {
              yawDeg = 0;
            }
          }
          // Rotate needle opposite to yaw so it represents North on screen.
          const rot = -yawDeg;
          compassNeedle.style.transform = `translate(-50%, -100%) rotate(${rot}deg)`;
        }

        // Expose to the animation loop.
        window.__atlasUpdateCompass = updateCompass;

        mapCompass?.addEventListener("click", () => {
          // Reset yaw to a north-up orientation without resetting distance/pitch.
          try {
            wasm.set_camera_yaw_deg(0);
          } catch (err) {
            // ignore
          }
          updateCompass();
        });

        let dragging = false;
        let dragMode = "orbit"; // orbit | pan
        let lockMode = "auto"; // auto | orbit | pan
        let lastX = 0;
        let lastY = 0;
        let downX = 0;
        let downY = 0;
        let downButton = 0;

        function onPointerDown(e) {
          const canvas = activeCanvas();
          canvas.setPointerCapture(e.pointerId);
          dragging = true;
          lastX = e.clientX;
          lastY = e.clientY;
          downX = e.clientX;
          downY = e.clientY;
          downButton = e.button;

          // If a mode is locked, use it; otherwise: left=orbit, right/shift=pan.
          if (lockMode === "pan") {
            dragMode = "pan";
          } else if (lockMode === "orbit") {
            dragMode = "orbit";
          } else if (e.button === 2 || e.shiftKey) {
            dragMode = "pan";
          } else {
            dragMode = "orbit";
          }
        }

        function onPointerMove(e) {
          if (!dragging) {
            try {
              const info = wasm.cursor_move(e.offsetX, e.offsetY);
              if (info && info.hit) {
                cursorText.textContent = `Cursor: lon ${info.lon.toFixed(4)}°, lat ${info.lat.toFixed(4)}°`;
              } else {
                cursorText.textContent = "Cursor: —";
              }
            } catch (err) {
              // ignore
            }
          }
          if (!dragging) return;
          const dx = e.clientX - lastX;
          const dy = e.clientY - lastY;
          lastX = e.clientX;
          lastY = e.clientY;

          try {
            if (dragMode === "pan") {
              wasm.camera_pan(dx, dy);
            } else {
              wasm.camera_orbit(dx, dy);
            }
            updateCompass();
          } catch (err) {
            console.error("camera input failed", err);
          }
        }

        function stopDrag() {
          dragging = false;
        }
        function onPointerUp(e) {
          // If it was a click (not a drag), run picking.
          const dx = e.clientX - downX;
          const dy = e.clientY - downY;
          const dist2 = dx * dx + dy * dy;
          if (downButton === 0 && dist2 < 16) {
            try {
              const picked = wasm.cursor_click(e.offsetX, e.offsetY);
              if (picked && picked.picked) {
                const kind = picked.kind ? String(picked.kind) : "feature";
                pickText.textContent = `Pick (${kind}): lon ${picked.lon.toFixed(4)}°, lat ${picked.lat.toFixed(4)}°`;
              } else {
                pickText.textContent = "Pick: —";
              }
            } catch (err) {
              console.error("pick failed", err);
            }
          }
          stopDrag();
        }

        function onWheel(e) {
          e.preventDefault();
          try {
            wasm.camera_zoom(e.deltaY);
            updateCompass();
          } catch (err) {
            console.error("camera_zoom failed", err);
          }
        }

        for (const c of [canvas2d, canvas3d]) {
          c.addEventListener("pointerdown", onPointerDown);
          c.addEventListener("pointermove", onPointerMove);
          c.addEventListener("pointerup", onPointerUp);
          c.addEventListener("pointercancel", stopDrag);
          c.addEventListener("pointerleave", stopDrag);
          c.addEventListener("wheel", onWheel, { passive: false });
        }

        window.addEventListener("keydown", (e) => {
          if (e.key === "r" || e.key === "R") {
            try {
              wasm.camera_reset();
              updateCompass();
            } catch (err) {
              console.error("camera_reset failed", err);
            }
          }
        });

        function syncMapToggles() {
          mapGraticule?.classList.toggle("active", !!toggleGraticule.checked);
          mapSun?.classList.toggle("active", !!toggleRealSun.checked);
          if (lockMode === "auto") mapMode.textContent = "Auto";
          if (lockMode === "orbit") mapMode.textContent = "Orbit";
          if (lockMode === "pan") mapMode.textContent = "Pan";
        }

        mapHome?.addEventListener("click", () => {
          try { wasm.camera_reset(); updateCompass(); } catch (err) { console.error("camera_reset failed", err); }
        });
        mapZoomIn?.addEventListener("click", () => {
          try { wasm.camera_zoom(-180); } catch (err) { console.error("camera_zoom failed", err); }
        });
        mapZoomOut?.addEventListener("click", () => {
          try { wasm.camera_zoom(180); } catch (err) { console.error("camera_zoom failed", err); }
        });
        mapMode?.addEventListener("click", () => {
          lockMode = lockMode === "auto" ? "orbit" : lockMode === "orbit" ? "pan" : "auto";
          syncMapToggles();
        });
        mapGraticule?.addEventListener("click", () => {
          toggleGraticule.checked = !toggleGraticule.checked;
          toggleGraticule.dispatchEvent(new Event("change"));
          syncMapToggles();
        });
        mapSun?.addEventListener("click", () => {
          toggleRealSun.checked = !toggleRealSun.checked;
          toggleRealSun.dispatchEvent(new Event("change"));
          syncMapToggles();
        });
        mapHelp?.addEventListener("click", () => {
          mapHelpText?.classList.toggle("hidden");
        });

        dataset.addEventListener("change", (e) => {
          const value = e.target.value;
          if (!value) return;
          wasm.set_dataset(value);
          setStatus(`Dataset: ${value}`);

          // If this is a known built-in dataset, enable its layer checkbox.
          if (value === "cities") layerCities.checked = true;
          if (value === "air_corridors") layerCorridors.checked = true;
          if (value === "regions") layerRegions.checked = true;
        });

        fileGeoJson.addEventListener("change", async () => {
          const file = fileGeoJson.files && fileGeoJson.files[0];
          if (!file) return;

          try {
            setStatus(`Loading ${file.name}…`);
            const text = await file.text();
            const summary = await wasm.load_geojson_file(file.name, text);

            // Add/update an Uploaded option in the dataset dropdown.
            const uploadedId = "__uploaded__";
            let opt = Array.from(dataset.options).find((o) => o.value === uploadedId);
            if (!opt) {
              opt = document.createElement("option");
              opt.value = uploadedId;
              dataset.appendChild(opt);
            }
            opt.textContent = `uploaded (${file.name})`;
            dataset.value = uploadedId;

            setUploadedInfo({
              name: summary?.name ?? file.name,
              points: summary?.points ?? 0,
              lines: summary?.lines ?? 0,
              polygons: summary?.polygons ?? 0,
            });

            // Enable uploaded layers (if present) and label them.
            layerUploadedPointsLabel.textContent = `Uploaded points (${file.name})`;
            layerUploadedCorridorsLabel.textContent = `Uploaded lines (${file.name})`;
            layerUploadedRegionsLabel.textContent = `Uploaded polygons (${file.name})`;
            layerUploadedPoints.checked = (summary?.points ?? 0) > 0;
            layerUploadedCorridors.checked = (summary?.lines ?? 0) > 0;
            layerUploadedRegions.checked = (summary?.polygons ?? 0) > 0;

            setStatus(`Uploaded: ${file.name}`);
          } catch (err) {
            console.error("GeoJSON upload failed", err);
            setStatus("Upload failed (see console)");
            setUploadedInfo({ error: err?.message ?? String(err) });
          } finally {
            // allow re-uploading the same file
            fileGeoJson.value = "";
          }
        });

        toggleGraticule.addEventListener("change", (e) => {
          const enabled = !!e.target.checked;
          try {
            wasm.set_graticule_enabled(enabled);
          } catch (err) {
            console.error("set_graticule_enabled failed", err);
          }
          syncMapToggles();
        });

        toggleRealSun.addEventListener("change", (e) => {
          const enabled = !!e.target.checked;
          try {
            wasm.set_real_time_sun_enabled(enabled);
          } catch (err) {
            console.error("set_real_time_sun_enabled failed", err);
          }
          syncMapToggles();
        });

        function applyCitySize() {
          const v = Number(citySize.value);
          citySizeValue.textContent = String(v);
          try {
            wasm.set_city_marker_size(v);
          } catch (err) {
            console.error("set_city_marker_size failed", err);
          }
        }

        function applyLineWidth() {
          const v = Number(lineWidth.value);
          lineWidthValue.textContent = String(v);
          try {
            wasm.set_line_width_px(v);
          } catch (err) {
            console.error("set_line_width_px failed", err);
          }
        }

        citySize.addEventListener("input", applyCitySize);
        // Apply once at startup to sync wasm state.
        applyCitySize();

        lineWidth.addEventListener("input", applyLineWidth);
        applyLineWidth();

        syncMapToggles();

        // Panel toggle and resize functionality
        const PANEL_DEFAULT_WIDTH = 320;
        const PANEL_MIN_WIDTH = 280;
        const PANEL_MAX_WIDTH = 600;
        
        const panel = document.getElementById("side-panel");
        const panelToggle = document.getElementById("panel-toggle");
        const resizeHandle = document.getElementById("panel-resize-handle");
        const app = document.getElementById("app");

        // Load saved panel state from localStorage
        const savedWidth = localStorage.getItem("panel-width");
        const savedCollapsed = localStorage.getItem("panel-collapsed") === "true";
        
        if (savedCollapsed) {
          panel.classList.add("collapsed");
          panelToggle.textContent = "▶";
          panelToggle.title = "Expand panel";
          app.style.setProperty("--panel-width", "0px");
        } else if (savedWidth) {
          app.style.setProperty("--panel-width", savedWidth + "px");
        } else {
          // Set default width explicitly for consistency
          app.style.setProperty("--panel-width", PANEL_DEFAULT_WIDTH + "px");
        }

        // Toggle panel collapse/expand
        panelToggle.addEventListener("click", () => {
          const isCollapsed = panel.classList.toggle("collapsed");
          panelToggle.textContent = isCollapsed ? "▶" : "◀";
          panelToggle.title = isCollapsed ? "Expand panel" : "Collapse panel";
          
          if (isCollapsed) {
            app.style.setProperty("--panel-width", "0px");
            localStorage.setItem("panel-collapsed", "true");
          } else {
            // Get the most recent width from localStorage
            const currentSavedWidth = localStorage.getItem("panel-width");
            const width = currentSavedWidth || PANEL_DEFAULT_WIDTH;
            app.style.setProperty("--panel-width", width + "px");
            localStorage.setItem("panel-collapsed", "false");
          }
          
          resizeCanvas(wasm);
        });

        // Resize functionality
        let isResizing = false;
        let startX = 0;
        let startWidth = 0;

        const onMouseMove = (e) => {
          if (!isResizing) return;
          const delta = e.clientX - startX;
          const newWidth = Math.max(PANEL_MIN_WIDTH, Math.min(PANEL_MAX_WIDTH, startWidth + delta));
          app.style.setProperty("--panel-width", newWidth + "px");
        };

        const onMouseUp = () => {
          if (!isResizing) return;
          isResizing = false;
          resizeHandle.classList.remove("resizing");
          // Save the new width and resize canvas once
          const currentWidth = panel.offsetWidth;
          if (currentWidth > 0) {
            localStorage.setItem("panel-width", currentWidth.toString());
          }
          resizeCanvas(wasm);
          // Remove listeners to avoid unnecessary event handling
          document.removeEventListener("mousemove", onMouseMove);
          document.removeEventListener("mouseup", onMouseUp);
        };

        resizeHandle.addEventListener("mousedown", (e) => {
          if (panel.classList.contains("collapsed")) return;
          isResizing = true;
          startX = e.clientX;
          startWidth = panel.offsetWidth;
          resizeHandle.classList.add("resizing");
          e.preventDefault();
          // Add listeners only when resizing
          document.addEventListener("mousemove", onMouseMove);
          document.addEventListener("mouseup", onMouseUp);
        });

        setStatus("Controls: LMB drag=orbit, RMB/Shift+drag=pan, wheel=zoom, R=reset, click=pick");

        // Default view mode.
        applyViewMode("3d");
      }

      function bootstrap() {
        const alreadyLoaded = window.wasmBindings;
        if (alreadyLoaded) {
          main(alreadyLoaded);
          return;
        }

        window.addEventListener("TrunkApplicationStarted", () => {
          if (!window.wasmBindings) {
            console.error("Trunk started but wasmBindings missing");
            return;
          }
          main(window.wasmBindings);
        });
      }

      bootstrap();
    </script>
  </body>
</html>
